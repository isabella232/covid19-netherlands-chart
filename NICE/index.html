<!doctype html>

<meta charset="utf-8">

<script type="text/javascript" src="./api.js"></script>

<h1><title style="display: block;">
  Cloudflare Worker for Stichting NICE - COVID-19 infection in Dutch ICU
</title></h1>

<h2>Introduction</h2>

<p>
  The Dutch Foundation for National Intensive Care Evaluation (Stichting NICE)
  has an overview of information related to COVID-19 cases in Intensive Care
  (IC): <a href="https://www.stichting-nice.nl/covid-19-op-de-ic.jsp">https://www.stichting-nice.nl/covid-19-op-de-ic.jsp</a>.
</p>

<p>
  The source of this information comes from 6 separate API endpoints.
  <br>
  I wanted to use this date for my COVID-19 chart but I did not feel much like
  making 6 HTTP calls for each request. To solve this, I create an API that makes
  the calls and combines them into one endpoint.
</p>

<p>
  This is an HTML representation of the Javascript code in
  <a href="./api.js">api.js</a> being executed.
</p>

<p>
  It is mostly meant for development and testing purposes.
  For production use this Cloudflare Worker:
  <a href="https://covid-19-ic.potherca.workers.dev/">https://covid-19-ic.potherca.workers.dev/</a>
</p>

<p>
  More information can be found at
  <a href="https://github.com/potherca-blog/covid19-netherlands-chart/tree/master/NICE">https://github.com/potherca-blog/covid19-netherlands-chart/tree/master/NICE</a>
</p>

<h2>Response</h2>

<div data-js="errors" style="display:none; color:red; border:1px solid;padding: 1em;"></div>

<h3>Headers</h3>

<pre data-js="response-headers"></pre>

<h3>Body</h3>

<pre data-js="response-body"></pre>

<script>  /*global dispatchEvent, Event, Request, URL */

  const handleError = e => {
    const errorElement = document.querySelector('[data-js="errors"]')
    errorElement.innerHTML += e
    errorElement.style.display = 'initial'

    console.error(e)
  }

  const event = new Event('fetch', {})

  event.request = new Request(document.location)

  event.response = null

  event.respondWith = input => event.response = input

  try {
    dispatchEvent(event)
  } catch (e) {
    handleError(e)
  }

  event.response
    .then(e => {
      e.json().then(data => {

        const searchParams = new URL(document.location).searchParams

        let indent = 0
        if (searchParams.has('pretty') || searchParams.has('verbose')) {
          indent = 2
        }

        document.querySelector('[data-js="response-headers"]').innerHTML += JSON.stringify(Object.fromEntries(e.headers.entries()), null, 2)

        document.querySelector('[data-js="response-body"]').innerHTML += JSON.stringify(data, null, indent)
      })
    }).catch(handleError)
</script>
